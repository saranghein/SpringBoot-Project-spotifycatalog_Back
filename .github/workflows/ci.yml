name: CI

on:
  push:
  pull_request:
  
permissions:
  contents: write
  checks: write
  pull-requests: write
  pages: write
  id-token: write
  
jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.4
        env:
          MYSQL_ROOT_PASSWORD: root1234
          MYSQL_DATABASE: spotifycatalog_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -proot1234"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            mysqladmin ping -h 127.0.0.1 -uroot -proot1234 && exit 0
            sleep 2
          done
          exit 1

      # dataset 캐시
      - name: Cache dataset
        id: cache-dataset
        uses: actions/cache@v4
        with:
          path: src/test/resources/dataset
          key: dataset-${{ runner.os }}-kaggle-spotify-900k-v1

      - name: Download dataset (if not cached)
        if: steps.cache-dataset.outputs.cache-hit != 'true'
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        run: |
          pip install -q kaggle

          mkdir -p ~/.kaggle
          cat > ~/.kaggle/kaggle.json << EOF
          {"username":"$KAGGLE_USERNAME","key":"$KAGGLE_KEY"}
          EOF
          chmod 600 ~/.kaggle/kaggle.json

          mkdir -p src/test/resources/dataset
          kaggle datasets download -d devdope/900k-spotify -p src/test/resources/dataset --unzip
          
      - name: Run tests
        env:
          SPRING_PROFILES_ACTIVE: test
          GRADLE_OPTS: >-
            -Dorg.gradle.daemon=false
            -Dorg.gradle.jvmargs="-Xms256m -Xmx2g -XX:MaxMetaspaceSize=512m -Dfile.encoding=UTF-8"
          _JAVA_OPTIONS: >-
            -Xms256m -Xmx2g -XX:MaxMetaspaceSize=512m -Dfile.encoding=UTF-8
        run: ./gradlew test --no-daemon --stacktrace
              
      # PR/Checks에 테스트 요약 표시
      - name: Publish test results to PR
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: JUnit Test Results
          path: build/test-results/test/*.xml
          reporter: java-junit
          fail-on-error: false

      # 아티팩트도 남기기
      - name: Upload test report artifact (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: build/reports/tests/test

      # 아티팩트 업로드 (HTML 리포트)
      - name: Upload Pages artifact (test report)
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/reports/tests/test

  deploy-pages:
    runs-on: ubuntu-latest
    needs: test
    if: always() # 테스트 실패해도 리포트 배포는 시도(리포트가 생성되는 범위에서)
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
